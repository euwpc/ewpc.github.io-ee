<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Estonia Thunderstorm Outlook</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
  body { margin: 0; background: #0b0f14; color: white; font-family: Arial; }
  #map { height: 100vh; width: 100vw; }
  .legend { position: absolute; bottom: 20px; left: 20px; background:#111;padding:10px;border-radius:8px;}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

// ---- CONFIG ----
const MODELS = ["ecmwf", "icon-eu", "harmonie-dmi", "swiss4x4"];

const AREA = {
  minLat: 57.3,
  maxLat: 59.7,
  minLon: 21.0,
  maxLon: 28.3,
  step: 0.1
};

// ---- MAP ----
const map = L.map("map").setView([58.8, 25.3], 7);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let polygonLayer = L.layerGroup().addTo(map);

// ---- MAIN FETCH ----
async function fetchField(model, lat, lon, param) {
  const url =
  const url =
  `https://test.estoniaweather.workers.dev/?endpoint=/latest/${param}/${lat},${lon}/json?model=${model}`;

  const r = await fetch(url);
  const j = await r.json();
  return j.data[0].coordinates[0].dates[0].value;
}

// Fetch grid over Estonia
async function fetchGrid() {
  const grid = [];
  for (let lat = AREA.minLat; lat <= AREA.maxLat; lat += AREA.step) {
    const row = [];
    for (let lon = AREA.minLon; lon <= AREA.maxLon; lon += AREA.step) {
      const cape = await fetchField("ecmwf", lat, lon, "cape_ml:Jkg");
      const shear = await fetchField("ecmwf", lat, lon, "wind_speed_shear_0_6km:ms");
      const srh = await fetchField("ecmwf", lat, lon, "storm_relative_helicity_0_3km:ms2");
      row.push({ lat, lon, cape, shear, srh });
    }
    grid.push(row);
  }
  return grid;
}

// ---- CATEGORY LOGIC ----
function category(c) {
  if (c.cape > 2500 && c.shear > 30 && c.srh > 250) return "HIGH";
  if (c.cape > 1800 && c.shear > 25 && c.srh > 200) return "MDT";
  if (c.cape > 1200 && c.shear > 20 && c.srh > 150) return "ENH";
  if (c.cape > 700 && c.shear > 15 && c.srh > 120) return "SLGT";
  if (c.cape > 300 && c.shear > 10 && c.srh > 80) return "MRGL";
  if (c.cape > 100) return "TSTM";
  return null;
}

const COLORS = {
  TSTM: "#00b7ff",
  MRGL: "#14ed00",
  SLGT: "#ffde59",
  ENH: "#ff9a00",
  MDT: "#ff3b3b",
  HIGH: "#b300ff"
};

// ---- POLYGON CREATION ----
function createPolygons(grid) {
  polygonLayer.clearLayers();

  grid.forEach(row => {
    row.forEach(cell => {
      const cat = category(cell);
      if (!cat) return;

      // Draw a rectangle cell as polygon
      const poly = [
        [cell.lat, cell.lon],
        [cell.lat + AREA.step, cell.lon],
        [cell.lat + AREA.step, cell.lon + AREA.step],
        [cell.lat, cell.lon + AREA.step]
      ];

      L.polygon(poly, { color: COLORS[cat], fillOpacity: 0.35 })
        .addTo(polygonLayer)
        .bindPopup(`${cat}<br>CAPE: ${cell.cape}<br>Shear: ${cell.shear}<br>SRH: ${cell.srh}`);
    });
  });
}

// ---- RUN ----
(async () => {
  const grid = await fetchGrid();
  createPolygons(grid);
})();
</script>
</body>
</html>
